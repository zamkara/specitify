#!/bin/sh
set -e

SCRIPT_VERSION="2026-02-13-05"

info() { printf "%s\n" "$*"; }
warn() { printf "Warning: %s\n" "$*" >&2; }
die() { printf "Error: %s\n" "$*" >&2; exit 1; }

confirm() {
  printf "%s [Y/n] " "$1"
  read ans
  case "$ans" in
    ""|Y|y|yes|YES) return 0 ;;
    *) return 1 ;;
  esac
}

fetch_cmd() {
  if command -v curl >/dev/null 2>&1; then
    printf "%s" "curl -fsSL"
  elif command -v wget >/dev/null 2>&1; then
    printf "%s" "wget -qO-"
  else
    die "curl or wget is required."
  fi
}

FETCH="$(fetch_cmd)"

OS="$(uname -s 2>/dev/null || echo unknown)"
info "specitify unix installer v$SCRIPT_VERSION"

SPICETIFY_BIN=""

ensure_spicetify_path() {
  if [ -x "$HOME/.spicetify/spicetify" ]; then
    case ":$PATH:" in
      *":$HOME/.spicetify:"*) ;;
      *) export PATH="$HOME/.spicetify:$PATH" ;;
    esac
  fi
}

detect_spicetify_bin() {
  ensure_spicetify_path
  if command -v spicetify >/dev/null 2>&1; then
    SPICETIFY_BIN="$(command -v spicetify)"
  elif [ -x "$HOME/.spicetify/spicetify" ]; then
    SPICETIFY_BIN="$HOME/.spicetify/spicetify"
  else
    SPICETIFY_BIN=""
  fi
}

fetch_file() {
  url="$1"
  out="$2"
  if command -v curl >/dev/null 2>&1; then
    curl -fL -o "$out" "$url"
  elif command -v wget >/dev/null 2>&1; then
    wget -qO "$out" "$url"
  else
    die "curl or wget is required."
  fi
}

run_remote_sh() {
  url="$1"
  script="$(mktemp /tmp/spicetify.XXXXXX.sh)"
  fetch_file "$url" "$script"
  ensure_spicetify_path
  PATH="$HOME/.spicetify:$PATH" sh "$script"
  rm -f "$script"
}

install_spicetify() {
  info "Installing Spicetify..."
  if [ "$(id -u)" -eq 0 ]; then
    die "Do not run as root. Re-run without sudo."
  fi

  if ! command -v tar >/dev/null 2>&1; then
    die "tar is required."
  fi

  target=""
  case "$(uname -s) $(uname -m)" in
    "Darwin x86_64") target="darwin-amd64" ;;
    "Darwin arm64") target="darwin-arm64" ;;
    "Linux x86_64") target="linux-amd64" ;;
    "Linux aarch64"|"Linux arm64") target="linux-arm64" ;;
    *) die "Unsupported platform $(uname -s) $(uname -m)" ;;
  esac

  releases_json="$($FETCH "https://api.github.com/repos/spicetify/cli/releases/latest")"
  tag="$(printf "%s" "$releases_json" | awk -F'"' '/"tag_name":/ {print $4; exit}')"
  tag="${tag#v}"
  [ -z "$tag" ] && die "Could not detect latest Spicetify version."

  install_dir="$HOME/.spicetify"
  exe="$install_dir/spicetify"
  tarball="$install_dir/spicetify.tar.gz"

  [ ! -d "$install_dir" ] && mkdir -p "$install_dir"

  url="https://github.com/spicetify/cli/releases/download/v$tag/spicetify-$tag-$target.tar.gz"
  info "Downloading Spicetify v$tag..."
  fetch_file "$url" "$tarball"
  tar xzf "$tarball" -C "$install_dir"
  chmod +x "$exe"
  rm -f "$tarball"

  add_spicetify_path "$install_dir"
  detect_spicetify_bin
}

marketplace_present() {
  if [ -d "$HOME/.config/spicetify/CustomApps/marketplace" ]; then
    return 0
  fi
  return 1
}

install_marketplace() {
  if confirm "Install Spicetify Marketplace?"; then
    if marketplace_present; then
      info "Marketplace already installed. Skipping."
      return 0
    fi
    info "Using local Marketplace installer."
    install_marketplace_local
  fi
}

post_notes() {
  info ""
  info "After Spotify updates, re-apply:"
  info "  spicetify backup apply"
  info "If that doesn't work, try:"
  info "  spicetify update"
  info "If you updated Spicetify via a package manager:"
  info "  spicetify restore backup apply"
}

set_spicetify_config() {
  detect_spicetify_bin
  if [ -n "$SPICETIFY_BIN" ]; then
    [ -n "$1" ] && "$SPICETIFY_BIN" config spotify_path "$1"
    [ -n "$2" ] && "$SPICETIFY_BIN" config prefs_path "$2"
  else
    warn "spicetify not found in PATH. Open a new shell and run:"
    [ -n "$1" ] && info "  spicetify config spotify_path \"$1\""
    [ -n "$2" ] && info "  spicetify config prefs_path \"$2\""
  fi
}

fix_permissions() {
  base="$1"
  apps="$1/Apps"
  if [ ! -d "$base" ]; then
    return 0
  fi
  if [ -w "$base" ]; then
    chmod a+wr "$base" 2>/dev/null || true
    [ -d "$apps" ] && chmod -R a+wr "$apps" 2>/dev/null || true
  else
    if confirm "Grant write permissions to $base (requires sudo)?"; then
      sudo chmod a+wr "$base"
      [ -d "$apps" ] && sudo chmod -R a+wr "$apps"
    else
      warn "Skipping permission changes."
    fi
  fi
}

handle_flatpak() {
  info "Detected Spotify Flatpak."
  spotify_path=""
  prefs_path=""

  for p in \
    "/var/lib/flatpak/app/com.spotify.Client/x86_64/stable/active/files/extra/share/spotify" \
    "$HOME/.local/share/flatpak/app/com.spotify.Client/x86_64/stable/active/files/extra/share/spotify"
  do
    if [ -d "$p" ]; then
      spotify_path="$p"
      break
    fi
  done

  if [ -f "$HOME/.var/app/com.spotify.Client/config/spotify/prefs" ]; then
    prefs_path="$HOME/.var/app/com.spotify.Client/config/spotify/prefs"
  elif [ -f "$HOME/.config/spotify/prefs" ]; then
    prefs_path="$HOME/.config/spotify/prefs"
  fi

  if [ -z "$spotify_path" ]; then
    warn "Could not auto-detect Flatpak Spotify path."
    info "Try running: flatpak --installations"
  else
    info "Using spotify_path: $spotify_path"
  fi

  if [ -n "$prefs_path" ]; then
    info "Using prefs_path: $prefs_path"
  else
    warn "Could not find prefs file."
    info "Check:"
    info "  $HOME/.config/spotify/prefs"
    info "  $HOME/.var/app/com.spotify.Client/config/spotify/prefs"
  fi

  set_spicetify_config "$spotify_path" "$prefs_path"

  [ -n "$spotify_path" ] && fix_permissions "$spotify_path"
}

handle_snap() {
  warn "Snap Spotify detected. Snap apps cannot be modified."
  info "Recommended: switch to apt version. Commands:"
  info "  sudo snap remove spotify"
  info "  curl -sS https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg | sudo gpg --dearmor --yes -o /etc/apt/trusted.gpg.d/spotify.gpg"
  info "  echo \"deb http://repository.spotify.com stable non-free\" | sudo tee /etc/apt/sources.list.d/spotify.list"
  info "  sudo apt-get update && sudo apt-get install spotify-client"
  info "Then grant permissions:"
  info "  sudo chmod a+wr /usr/share/spotify"
  info "  sudo chmod a+wr -R /usr/share/spotify/Apps"
}

handle_linux_paths() {
  if [ -d "/usr/share/spotify" ]; then
    set_spicetify_config "/usr/share/spotify" "$HOME/.config/spotify/prefs"
    fix_permissions "/usr/share/spotify"
  else
    warn "Could not find /usr/share/spotify."
    info "If Spotify is installed elsewhere, set it manually:"
    info "  spicetify config spotify_path /path/to/spotify"
    info "  spicetify config prefs_path /path/to/prefs"
  fi
}

add_spicetify_path() {
  install_dir="$1"
  path_line="export PATH=\$PATH:$install_dir"
  append_line() {
    file="$1"
    [ ! -f "$file" ] && touch "$file"
    if ! grep -q "$install_dir" "$file"; then
      printf "\n%s\n" "$path_line" >> "$file"
      export PATH="$install_dir:$PATH"
    fi
  }

  case "$SHELL" in
    *zsh) append_line "${ZDOTDIR:-$HOME}/.zshrc" ;;
    *bash)
      [ -f "$HOME/.bashrc" ] && append_line "$HOME/.bashrc"
      [ -f "$HOME/.bash_profile" ] && append_line "$HOME/.bash_profile"
      [ ! -f "$HOME/.bashrc" ] && [ ! -f "$HOME/.bash_profile" ] && append_line "$HOME/.bashrc"
      ;;
    *fish)
      cfg="$HOME/.config/fish/config.fish"
      [ ! -f "$cfg" ] && touch "$cfg"
      if ! grep -q "$install_dir" "$cfg"; then
        printf "\nfish_add_path %s\n" "$install_dir" >> "$cfg"
        export PATH="$install_dir:$PATH"
      fi
      ;;
    *) warn "Unknown shell. Add to PATH manually: $path_line" ;;
  esac
}

get_marketplace_tag() {
  tag="$($FETCH "https://api.github.com/repos/spicetify/marketplace/releases/latest" \
    | awk -F'"' '/"tag_name":/ {print $4; exit}')"
  if [ -z "$tag" ]; then
    warn "Could not detect latest Marketplace release tag."
  fi
  printf "%s" "$tag"
}

install_marketplace_local() {
  detect_spicetify_bin
  if [ -z "$SPICETIFY_BIN" ]; then
    warn "spicetify not found. Install Spicetify first."
    return 1
  fi

  if ! command -v unzip >/dev/null 2>&1; then
    warn "unzip not found. Please install unzip and retry."
    return 1
  fi

  tag="$(get_marketplace_tag)"
  [ -z "$tag" ] && tag="v1.0.8"

  zip_url="https://github.com/spicetify/marketplace/releases/download/$tag/marketplace.zip"
  tmpdir="$(mktemp -d /tmp/marketplace.XXXXXX)"
  zip="$tmpdir/marketplace.zip"

  info "Downloading Marketplace $tag..."
  fetch_file "$zip_url" "$zip"

  custom_apps="$HOME/.config/spicetify/CustomApps"
  mkdir -p "$custom_apps"

  unzip -q "$zip" -d "$tmpdir"
  if [ -d "$tmpdir/marketplace" ]; then
    rm -rf "$custom_apps/marketplace"
    cp -R "$tmpdir/marketplace" "$custom_apps/marketplace"
  else
    warn "Unexpected marketplace zip structure."
  fi

  rm -rf "$tmpdir"

  "$SPICETIFY_BIN" config custom_apps marketplace
  "$SPICETIFY_BIN" config current_theme marketplace
  "$SPICETIFY_BIN" config inject_css 1
  "$SPICETIFY_BIN" config replace_colors 1

  info "Marketplace installed. Run:"
  info "  spicetify apply"
}

apply_spicetify() {
  detect_spicetify_bin
  if [ -z "$SPICETIFY_BIN" ]; then
    warn "spicetify not found. Skipping apply."
    return 1
  fi
  prefs_path="$("$SPICETIFY_BIN" -c 2>/dev/null | awk -F': ' '/prefs/ {print $2; exit}')"
  if [ -z "$prefs_path" ] && [ "$OS" = "Darwin" ]; then
    prefs_path="$HOME/Library/Application Support/Spotify/prefs"
  fi
  if [ -z "$prefs_path" ] || [ ! -f "$prefs_path" ]; then
    if [ "$OS" = "Darwin" ] && command -v open >/dev/null 2>&1; then
      info "Opening Spotify to generate prefs..."
      open -a "Spotify" >/dev/null 2>&1 || true
    elif command -v spotify >/dev/null 2>&1; then
      info "Launching Spotify to generate prefs..."
      spotify >/dev/null 2>&1 &
    fi

    i=0
    while [ $i -lt 120 ]; do
      if [ -z "$prefs_path" ]; then
        prefs_path="$("$SPICETIFY_BIN" -c 2>/dev/null | awk -F': ' '/prefs/ {print $2; exit}')"
      fi
      [ -n "$prefs_path" ] && [ -f "$prefs_path" ] && break
      sleep 1
      i=$((i+1))
    done
  fi
  if [ -z "$prefs_path" ] || [ ! -f "$prefs_path" ]; then
    warn "Prefs file not found. Open Spotify once, then run:"
    info "  $SPICETIFY_BIN apply"
    return 1
  fi
  "$SPICETIFY_BIN" backup apply
  "$SPICETIFY_BIN" apply
}

find_spotify_app_macos() {
  if [ -d "/Applications/Spotify.app" ]; then
    printf "%s" "/Applications/Spotify.app"
    return 0
  fi
  if [ -d "$HOME/Applications/Spotify.app" ]; then
    printf "%s" "$HOME/Applications/Spotify.app"
    return 0
  fi
  if command -v mdfind >/dev/null 2>&1; then
    app="$(mdfind "kMDItemCFBundleIdentifier == 'com.spotify.client'" 2>/dev/null | head -n 1)"
    if [ -n "$app" ] && [ -d "$app" ]; then
      printf "%s" "$app"
      return 0
    fi
  fi
  return 1
}

install_spotify_macos() {
  info "Downloading Spotify for macOS..."
  dmg="$(mktemp /tmp/spotify.XXXXXX.dmg)"
  fetch_file "https://download.scdn.co/Spotify.dmg" "$dmg"

  info "Mounting Spotify.dmg..."
  mountpoint="$(hdiutil attach "$dmg" -nobrowse | awk '/Volumes/ {print $3; exit}')"
  if [ -z "$mountpoint" ] || [ ! -d "$mountpoint" ]; then
    rm -f "$dmg"
    die "Failed to mount Spotify.dmg"
  fi

  src_app="$mountpoint/Spotify.app"
  if [ ! -d "$src_app" ]; then
    hdiutil detach "$mountpoint" >/dev/null 2>&1 || true
    rm -f "$dmg"
    die "Spotify.app not found in dmg"
  fi

  target="/Applications/Spotify.app"
  if [ ! -w "/Applications" ]; then
    if confirm "Install Spotify to ~/Applications (no sudo)?"; then
      mkdir -p "$HOME/Applications"
      target="$HOME/Applications/Spotify.app"
      rm -rf "$target"
      cp -R "$src_app" "$target"
    else
      if confirm "Install Spotify to /Applications (requires sudo)?"; then
        sudo rm -rf "$target"
        sudo cp -R "$src_app" "$target"
      else
        warn "Skipping Spotify installation."
      fi
    fi
  else
    rm -rf "$target"
    cp -R "$src_app" "$target"
  fi

  hdiutil detach "$mountpoint" >/dev/null 2>&1 || true
  rm -f "$dmg"
}

handle_macos() {
  app_path="$(find_spotify_app_macos || true)"
  if [ -z "$app_path" ]; then
    warn "Spotify.app not found."
    if confirm "Install Spotify for macOS now?"; then
      install_spotify_macos
      app_path="$(find_spotify_app_macos || true)"
    fi
  fi

  spotify_path=""
  if [ -n "$app_path" ]; then
    spotify_path="$app_path/Contents/Resources"
    info "Using spotify_path: $spotify_path"
  else
    warn "Could not detect Spotify app location."
  fi

  prefs_path="$HOME/Library/Application Support/Spotify/prefs"
  if [ ! -f "$prefs_path" ]; then
    warn "Prefs file not found. Open Spotify once to generate it:"
    info "  $prefs_path"
    if confirm "Open Spotify now to generate prefs?"; then
      open -a "Spotify" >/dev/null 2>&1 || true
      i=0
      while [ $i -lt 30 ]; do
        [ -f "$prefs_path" ] && break
        sleep 1
        i=$((i+1))
      done
    fi
  fi

  install_spicetify
  set_spicetify_config "$spotify_path" "$prefs_path"
  install_marketplace
  apply_spicetify
  post_notes
}

if [ "$OS" = "Darwin" ]; then
  handle_macos
  exit 0
fi

if [ "$OS" = "Linux" ]; then
  install_spicetify

  if command -v snap >/dev/null 2>&1 && snap list spotify >/dev/null 2>&1; then
    handle_snap
    install_marketplace
    post_notes
    exit 0
  fi

  if command -v flatpak >/dev/null 2>&1 && flatpak info com.spotify.Client >/dev/null 2>&1; then
    handle_flatpak
  else
    handle_linux_paths
  fi

  install_marketplace
  apply_spicetify
  post_notes
  exit 0
fi

die "Unsupported OS: $OS"
